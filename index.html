<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å - –£—á–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</title>
    <style>
        /* –í—Å–µ –≤–∞—à–∏ —Å—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: #f4f7fc;
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–æ–≥–∏–Ω–∞ */
        .login-container {
            max-width: 400px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .login-container h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-form .form-group {
            margin-bottom: 20px;
        }
        
        .login-form label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }
        
        .login-form input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #cbd5e0;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .login-btn {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .error-message {
            color: #f56565;
            text-align: center;
            margin-top: 15px;
        }
        
        .info-message {
            background: #ebf8ff;
            border: 1px solid #4299e1;
            color: #2c5282;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .warning-message {
            background: #feebc8;
            border: 1px solid #dd6b20;
            color: #7b341e;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .success-message {
            background: #c6f6d5;
            border: 1px solid #38a169;
            color: #22543d;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .container {
            max-width: 1400px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 15px;
        }
        
        .header-with-logout {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 1.8rem;
        }
        
        .logout-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .sync-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .sync-success {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .sync-error {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .sync-loading {
            background: #feebc8;
            color: #7b341e;
        }
        
        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∞—à–∏ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        .report-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .report-item {
            text-align: center;
        }
        .report-item span {
            display: block;
            font-size: 1.8rem;
            font-weight: bold;
        }
        .form-section {
            background: #f8fafd;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .form-group {
            width: 100%;
        }
        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 4px;
            text-transform: uppercase;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 8px;
        }
        .btn-secondary {
            background: #48bb78;
        }
        .btn-danger {
            background: #f56565;
        }
        .btn-sync {
            background: #4299e1;
            margin-right: 10px;
        }
        .form-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
        }
        .filter-bar {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
            background: white;
            padding: 15px;
            border-radius: 15px;
            border: 1px solid #edf2f7;
        }
        .table-wrapper {
            overflow-x: auto;
            border-radius: 15px;
            border: 1px solid #e2e8f0;
            background: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1300px;
        }
        th {
            background: #f7fafc;
            color: #2d3748;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
        }
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #edf2f7;
            color: #2d3748;
            font-size: 0.85rem;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .status-done { background: #c6f6d5; color: #22543d; }
        .status-late { background: #fed7d7; color: #742a2a; }
        .status-notcome { background: #e2e8f0; color: #2d3748; }
        .status-waiting { background: #fefcbf; color: #744210; }
        .oil-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .oil-yes { background: #c6f6d5; color: #22543d; }
        .oil-no { background: #e2e8f0; color: #2d3748; }
        .oil-soon { background: #fefcbf; color: #744210; }
        .actions button {
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 6px;
        }
        .edit-btn { color: #4299e1; }
        .delete-btn { color: #f56565; }
        .total-row {
            background: #f0f4f8;
            font-weight: 700;
            border-top: 2px solid #667eea;
        }
        
        @media (min-width: 768px) {
            .form-row { flex-direction: row; flex-wrap: wrap; }
            .form-group { flex: 1 1 180px; }
            .btn { width: auto; }
            .form-actions { flex-direction: row; }
            .report-panel { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –ª–æ–≥–∏–Ω–∞ -->
    <div id="loginScreen" class="login-container">
        <h2>üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
        <div class="info-message">
            <strong>–î–µ–º–æ-–¥–æ—Å—Ç—É–ø:</strong><br>
            –õ–æ–≥–∏–Ω: admin<br>
            –ü–∞—Ä–æ–ª—å: admin
        </div>
        <div class="warning-message" id="configWarning" style="display: none;">
            ‚ö†Ô∏è –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω config.js<br>
            <small>–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª config.js —Å –≤–∞—à–∏–º–∏ –∫–ª—é—á–∞–º–∏ JSONbin.io</small>
        </div>
        <div class="login-form">
            <div class="form-group">
                <label>–õ–æ–≥–∏–Ω</label>
                <input type="text" id="loginUsername" value="admin" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="loginPassword" value="admin" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <button class="login-btn" id="loginBtn">–í–æ–π—Ç–∏</button>
            <div id="loginError" class="error-message"></div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="appScreen" style="display: none;" class="container">
        <div class="header-with-logout">
            <h1>
                üîß –£—á–µ—Ç - –ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å
                <span id="syncStatus" class="sync-status sync-loading">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>
            </h1>
            <div>
                <button class="btn-sync btn" id="syncNowBtn">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="logout-btn" id="logoutBtn">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <!-- –û—Ç—á–µ—Ç -->
        <div class="report-panel">
            <div class="report-item">
                <span id="totalClients">0</span>
                <label>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</label>
            </div>
            <div class="report-item">
                <span id="waitingCount">0</span>
                <label>–û–∂–∏–¥–∞–µ–º</label>
            </div>
            <div class="report-item">
                <span id="lateCount">0</span>
                <label>–û–ø–∞–∑–¥—ã–≤–∞—é—Ç</label>
            </div>
            <div class="report-item">
                <span id="doneCount">0</span>
                <label>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
        <div class="form-section">
            <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>ID (K-)</label>
                    <input type="text" id="clientId" readonly placeholder="K-1001">
                </div>
                <div class="form-group">
                    <label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <input type="text" id="userName" placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤">
                </div>
                <div class="form-group">
                    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="text" id="phone" placeholder="+7 (999) 123-45-67">
                </div>
                <div class="form-group">
                    <label>–ú–∞—Ä–∫–∞ –∞–≤—Ç–æ</label>
                    <input type="text" id="carModel" placeholder="Toyota Camry">
                </div>
                <div class="form-group">
                    <label>–î–∞—Ç–∞ –ø—Ä–∏–µ–∑–¥–∞</label>
                    <input type="date" id="visitDate">
                </div>
                <div class="form-group">
                    <label>–í—Ä–µ–º—è –ø—Ä–∏–µ–∑–¥–∞</label>
                    <input type="time" id="visitTime">
                </div>
                <div class="form-group">
                    <label>–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞</label>
                    <select id="oilChange">
                        <option value="–ù–µ—Ç">–ù–µ—Ç</option>
                        <option value="–î–∞">–î–∞</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–û–ø–ª–∞—Ç–∞ (‚ÇΩ)</label>
                    <input type="number" id="payment" placeholder="5000" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>–°—Ç–∞—Ç—É—Å</label>
                    <select id="statusSelect">
                        <option value="waiting">–û–∂–∏–¥–∞–µ–º</option>
                        <option value="late">–û–ø–∞–∑–¥—ã–≤–∞–µ—Ç</option>
                        <option value="done">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                        <option value="notcome">–ù–µ –ø—Ä–∏–µ–¥–µ—Ç</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea id="comment" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn" id="addBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="btn-secondary" id="updateBtn" style="display: none;">‚úÖ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn-danger" id="cancelEdit" style="display: none;">‚úñ –û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è -->
        <div class="filter-bar">
            <div class="filter-row">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫...">
                </div>
                <div class="filter-section">
                    <label>–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ:</label>
                    <div class="date-filter">
                        <select id="yearFilter">
                            <option value="all">–í—Å–µ –≥–æ–¥–∞</option>
                        </select>
                        <select id="monthFilter">
                            <option value="all">–í—Å–µ –º–µ—Å—è—Ü—ã</option>
                            <option value="1">–Ø–Ω–≤–∞—Ä—å</option>
                            <option value="2">–§–µ–≤—Ä–∞–ª—å</option>
                            <option value="3">–ú–∞—Ä—Ç</option>
                            <option value="4">–ê–ø—Ä–µ–ª—å</option>
                            <option value="5">–ú–∞–π</option>
                            <option value="6">–ò—é–Ω—å</option>
                            <option value="7">–ò—é–ª—å</option>
                            <option value="8">–ê–≤–≥—É—Å—Ç</option>
                            <option value="9">–°–µ–Ω—Ç—è–±—Ä—å</option>
                            <option value="10">–û–∫—Ç—è–±—Ä—å</option>
                            <option value="11">–ù–æ—è–±—Ä—å</option>
                            <option value="12">–î–µ–∫–∞–±—Ä—å</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="filter-row">
                <div class="filter-section">
                    <label>–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º:</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" class="status-checkbox" value="waiting" checked> –û–∂–∏–¥–∞–µ–º
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" class="status-checkbox" value="late" checked> –û–ø–∞–∑–¥—ã–≤–∞–µ—Ç
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" class="status-checkbox" value="done" checked> –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" class="status-checkbox" value="notcome" checked> –ù–µ –ø—Ä–∏–µ–¥–µ—Ç
                        </label>
                    </div>
                </div>

                <div class="filter-section">
                    <label>–§–∏–ª—å—Ç—Ä –ø–æ –∑–∞–º–µ–Ω–µ –º–∞—Å–ª–∞:</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="oilYes" checked> –î–∞
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="oilNo" checked> –ù–µ—Ç
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="oilSoon"> –°–∫–æ—Ä–æ –∑–∞–º–µ–Ω–∞
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
        <div class="table-wrapper">
            <table id="clientsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>–ú–∞—Ä–∫–∞ –∞–≤—Ç–æ</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–í—Ä–µ–º—è</th>
                        <th>–ú–∞—Å–ª–æ</th>
                        <th>–û–ø–ª–∞—Ç–∞ (‚ÇΩ)</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div class="footer-note">
            * –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ JSONbin.io. –î–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é -->
    <script src="config.js"></script>
    
    <script>
        (function() {
            // ========== –ü–†–û–í–ï–†–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ==========
            const configWarning = document.getElementById('configWarning');
            
            function checkConfig() {
                if (typeof CONFIG === 'undefined' || 
                    CONFIG.API_KEY === '–í–ê–®_API_–ö–õ–Æ–ß' || 
                    CONFIG.BIN_ID === '–í–ê–®_BIN_ID') {
                    configWarning.style.display = 'block';
                    return false;
                }
                return true;
            }

            // ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
            const LOGIN_SCREEN = document.getElementById('loginScreen');
            const APP_SCREEN = document.getElementById('appScreen');
            const LOGIN_BTN = document.getElementById('loginBtn');
            const LOGOUT_BTN = document.getElementById('logoutBtn');
            const SYNC_NOW_BTN = document.getElementById('syncNowBtn');
            const SYNC_STATUS = document.getElementById('syncStatus');
            const LOGIN_ERROR = document.getElementById('loginError');
            
            function setSyncStatus(status, message) {
                SYNC_STATUS.className = 'sync-status ' + status;
                SYNC_STATUS.textContent = message;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            function checkAuth() {
                const isAuthenticated = sessionStorage.getItem('auth') === 'true';
                if (isAuthenticated) {
                    showApp();
                } else {
                    showLogin();
                }
            }
            
            function showApp() {
                LOGIN_SCREEN.style.display = 'none';
                APP_SCREEN.style.display = 'block';
                if (!window.appInitialized) {
                    initApp();
                    window.appInitialized = true;
                } else {
                    // –ï—Å–ª–∏ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ, –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    if (window.appInstance && window.appInstance.loadFromServer) {
                        window.appInstance.loadFromServer();
                    }
                }
            }
            
            function showLogin() {
                LOGIN_SCREEN.style.display = 'block';
                APP_SCREEN.style.display = 'none';
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞
            LOGIN_BTN.addEventListener('click', function() {
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                
                if (username === 'admin' && password === 'admin') {
                    sessionStorage.setItem('auth', 'true');
                    LOGIN_ERROR.textContent = '';
                    showApp();
                } else {
                    LOGIN_ERROR.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                }
            });
            
            LOGOUT_BTN.addEventListener('click', function() {
                sessionStorage.removeItem('auth');
                showLogin();
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            checkAuth();

            // ========== –û–°–ù–û–í–ù–û–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ ==========
            function initApp() {
                const STORAGE_KEY = 'autoserviceData';
                const OIL_CHANGE_DAYS = 330;
                let editingId = null;
                let records = [];
                let syncTimeout = null;

                // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JSONbin.io
                async function saveToServer() {
                    if (!checkConfig()) {
                        setSyncStatus('sync-error', '‚ùå –ù–µ—Ç API –∫–ª—é—á–∞');
                        return false;
                    }
                    
                    setSyncStatus('sync-loading', 'üîÑ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
                    
                    try {
                        const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Master-Key': CONFIG.API_KEY
                            },
                            body: JSON.stringify(records)
                        });
                        
                        if (response.ok) {
                            setSyncStatus('sync-success', '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                            // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –∫–∞–∫ –±—ç–∫–∞–ø
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
                            return true;
                        } else {
                            throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                        }
                    } catch (e) {
                        console.error('Save error:', e);
                        setSyncStatus('sync-error', '‚ùå –û—à–∏–±–∫–∞');
                        return false;
                    }
                }

                async function loadFromServer() {
                    if (!checkConfig()) {
                        setSyncStatus('sync-error', '‚ùå –ù–µ—Ç API –∫–ª—é—á–∞');
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                        loadFromStorage();
                        return false;
                    }
                    
                    setSyncStatus('sync-loading', 'üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...');
                    
                    try {
                        const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}/latest`, {
                            headers: {
                                'X-Master-Key': CONFIG.API_KEY
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            records = data.record || [];
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
                            updateYearFilter();
                            renderTable();
                            setSyncStatus('sync-success', '‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ');
                            return true;
                        } else if (response.status === 404) {
                            // –ë–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                            records = getInitialData();
                            await saveToServer();
                            updateYearFilter();
                            renderTable();
                            return true;
                        } else {
                            throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                        }
                    } catch (e) {
                        console.error('Load error:', e);
                        setSyncStatus('sync-error', '‚ùå –û—à–∏–±–∫–∞');
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
                        loadFromStorage();
                        return false;
                    }
                }

                // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
                function loadFromStorage() {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) {
                        try {
                            records = JSON.parse(stored);
                            setSyncStatus('sync-warning', '‚ö†Ô∏è –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                        } catch (e) {
                            records = getInitialData();
                        }
                    } else {
                        records = getInitialData();
                    }
                    updateYearFilter();
                    renderTable();
                }

                // –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                function getInitialData() {
                    const today = new Date();
                    const threeMonthsAgo = new Date(today);
                    threeMonthsAgo.setMonth(today.getMonth() - 3);
                    
                    const elevenMonthsAgo = new Date(today);
                    elevenMonthsAgo.setMonth(today.getMonth() - 11);
                    
                    const formatDate = (date) => {
                        return date.toISOString().split('T')[0];
                    };

                    return [
                        { 
                            id: 'K-1001', 
                            name: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', 
                            phone: '+7 999 111-22-33', 
                            carModel: 'Toyota Camry',
                            visitDate: formatDate(threeMonthsAgo),
                            visitTime: '10:30',
                            oilChange: '–î–∞',
                            payment: 5000,
                            status: 'waiting',
                            comment: '–ü—Ä–æ—Å–∏–ª –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä'
                        },
                        { 
                            id: 'K-1002', 
                            name: '–ï–ª–µ–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞', 
                            phone: '+7 999 222-33-44', 
                            carModel: 'KIA Rio',
                            visitDate: '2026-02-13',
                            visitTime: '14:00',
                            oilChange: '–ù–µ—Ç',
                            payment: 3500,
                            status: 'done',
                            comment: '–ó–∞–º–µ–Ω–∞ —Ç–æ—Ä–º–æ–∑–Ω—ã—Ö –∫–æ–ª–æ–¥–æ–∫'
                        },
                        { 
                            id: 'K-1003', 
                            name: '–ü–µ—Ç—Ä –°–∏–¥–æ—Ä–æ–≤', 
                            phone: '+7 999 333-44-55', 
                            carModel: 'BMW X5',
                            visitDate: formatDate(elevenMonthsAgo),
                            visitTime: '09:15',
                            oilChange: '–î–∞',
                            payment: 12000,
                            status: 'late',
                            comment: '–°—Ä–æ—á–Ω–æ, –∑–≤–æ–Ω–∏–ª —É–∂–µ 2 —Ä–∞–∑–∞'
                        },
                        { 
                            id: 'K-1004', 
                            name: '–ê–Ω–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞', 
                            phone: '+7 999 444-55-66', 
                            carModel: 'Hyundai Solaris',
                            visitDate: '2026-02-14',
                            visitTime: '16:45',
                            oilChange: '–î–∞',
                            payment: 4500,
                            status: 'notcome',
                            comment: '–ü–µ—Ä–µ–Ω–µ—Å–ª–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é'
                        }
                    ];
                }

                function saveToStorage() {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
                    
                    // –û—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –∑–∞–ø—Ä–æ—Å–∞–º–∏)
                    if (syncTimeout) clearTimeout(syncTimeout);
                    syncTimeout = setTimeout(() => {
                        saveToServer();
                    }, 2000);
                }

                function isOilChangeSoon(visitDate, oilChange) {
                    if (oilChange !== '–î–∞' || !visitDate) return false;
                    const visit = new Date(visitDate);
                    const today = new Date();
                    const diffTime = today - visit;
                    const diffDays = diffTime / (1000 * 60 * 60 * 24);
                    return diffDays >= OIL_CHANGE_DAYS;
                }

                function generateNewId() {
                    if (records.length === 0) return 'K-1001';
                    const numbers = records.map(c => {
                        const match = c.id.match(/^K-(\d+)$/);
                        return match ? parseInt(match[1], 10) : 0;
                    }).filter(n => !isNaN(n) && n > 0);
                    const maxNum = numbers.length > 0 ? Math.max(...numbers) : 1000;
                    return `K-${maxNum + 1}`;
                }

                function updateReport() {
                    const total = records.length;
                    let waiting = 0, late = 0, done = 0, notcome = 0;

                    records.forEach(r => {
                        if (r.status === 'waiting') waiting++;
                        else if (r.status === 'late') late++;
                        else if (r.status === 'done') done++;
                        else if (r.status === 'notcome') notcome++;
                    });

                    document.getElementById('totalClients').innerText = total;
                    document.getElementById('waitingCount').innerText = waiting;
                    document.getElementById('lateCount').innerText = late;
                    document.getElementById('doneCount').innerText = done;
                }

                function escapeHtml(unsafe) {
                    if (!unsafe) return '';
                    return String(unsafe)
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");
                }

                function getStatusInfo(status) {
                    switch(status) {
                        case 'done': return { text: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ', class: 'status-done' };
                        case 'late': return { text: '–û–ø–∞–∑–¥—ã–≤–∞–µ—Ç', class: 'status-late' };
                        case 'notcome': return { text: '–ù–µ –ø—Ä–∏–µ–¥–µ—Ç', class: 'status-notcome' };
                        default: return { text: '–û–∂–∏–¥–∞–µ–º', class: 'status-waiting' };
                    }
                }

                function getSelectedStatuses() {
                    const checkboxes = document.querySelectorAll('.status-checkbox');
                    const selected = [];
                    checkboxes.forEach(cb => { if (cb.checked) selected.push(cb.value); });
                    return selected;
                }

                function getSelectedOilValues() {
                    const selected = [];
                    if (document.getElementById('oilYes').checked) selected.push('–î–∞');
                    if (document.getElementById('oilNo').checked) selected.push('–ù–µ—Ç');
                    return selected;
                }

                function formatPayment(amount) {
                    if (amount === undefined || amount === null) return '0';
                    return Number(amount).toLocaleString('ru-RU');
                }

                function calculateTotal(filteredRecords) {
                    return filteredRecords.reduce((sum, record) => sum + (Number(record.payment) || 0), 0);
                }

                function updateYearFilter() {
                    const yearSelect = document.getElementById('yearFilter');
                    const years = new Set();
                    records.forEach(record => {
                        if (record.visitDate) {
                            years.add(new Date(record.visitDate).getFullYear());
                        }
                    });
                    
                    const sortedYears = Array.from(years).sort((a, b) => b - a);
                    const currentValue = yearSelect.value;
                    
                    yearSelect.innerHTML = '<option value="all">–í—Å–µ –≥–æ–¥–∞</option>';
                    sortedYears.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearSelect.appendChild(option);
                    });
                    
                    if (currentValue && currentValue !== 'all') {
                        if (sortedYears.includes(parseInt(currentValue))) {
                            yearSelect.value = currentValue;
                        }
                    }
                }

                function getSelectedYear() {
                    const yearValue = document.getElementById('yearFilter').value;
                    return yearValue === 'all' ? null : parseInt(yearValue);
                }

                function getSelectedMonth() {
                    const monthValue = document.getElementById('monthFilter').value;
                    return monthValue === 'all' ? null : parseInt(monthValue);
                }

                function renderTable() {
                    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                    const selectedStatuses = getSelectedStatuses();
                    const selectedOilValues = getSelectedOilValues();
                    const oilSoonChecked = document.getElementById('oilSoon').checked;
                    const selectedYear = getSelectedYear();
                    const selectedMonth = getSelectedMonth();

                    const filtered = records.filter(record => {
                        const matchesSearch = 
                            record.id.toLowerCase().includes(searchTerm) ||
                            record.name.toLowerCase().includes(searchTerm) ||
                            record.phone.toLowerCase().includes(searchTerm) ||
                            (record.carModel && record.carModel.toLowerCase().includes(searchTerm)) ||
                            (record.comment && record.comment.toLowerCase().includes(searchTerm));

                        if (!matchesSearch) return false;

                        if (selectedStatuses.length > 0 && !selectedStatuses.includes(record.status)) {
                            return false;
                        }

                        const oilSoon = isOilChangeSoon(record.visitDate, record.oilChange);
                        
                        if (oilSoonChecked) {
                            if (!oilSoon) return false;
                        } else {
                            if (selectedOilValues.length > 0 && !selectedOilValues.includes(record.oilChange || '–ù–µ—Ç')) {
                                return false;
                            }
                        }

                        if (record.visitDate) {
                            const visitDate = new Date(record.visitDate);
                            const visitYear = visitDate.getFullYear();
                            const visitMonth = visitDate.getMonth() + 1;
                            
                            if (selectedYear && visitYear !== selectedYear) return false;
                            if (selectedMonth && visitMonth !== selectedMonth) return false;
                        } else {
                            if (selectedYear || selectedMonth) return false;
                        }

                        return true;
                    });

                    const totalSum = calculateTotal(filtered);
                    const tbody = document.getElementById('tableBody');
                    tbody.innerHTML = '';

                    if (filtered.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="11" style="text-align:center; padding:40px;">–ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
                    } else {
                        filtered.forEach(record => {
                            const statusInfo = getStatusInfo(record.status);
                            const oilSoon = isOilChangeSoon(record.visitDate, record.oilChange);
                            
                            let oilClass = record.oilChange === '–î–∞' ? 'oil-yes' : 'oil-no';
                            let oilText = record.oilChange || '–ù–µ—Ç';
                            
                            if (oilSoon) {
                                oilClass = 'oil-soon';
                                oilText = '–°–∫–æ—Ä–æ';
                            }

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${escapeHtml(record.id)}</td>
                                <td>${escapeHtml(record.name)}</td>
                                <td>${escapeHtml(record.phone)}</td>
                                <td>${escapeHtml(record.carModel || '')}</td>
                                <td>${escapeHtml(record.visitDate || '')}</td>
                                <td>${escapeHtml(record.visitTime || '')}</td>
                                <td><span class="oil-badge ${oilClass}">${escapeHtml(oilText)}</span></td>
                                <td class="payment-cell">${formatPayment(record.payment)} ‚ÇΩ</td>
                                <td><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></td>
                                <td class="comment-cell">${escapeHtml(record.comment || '')}</td>
                                <td class="actions">
                                    <button class="edit-btn" data-id="${escapeHtml(record.id)}" title="–†–µ–¥.">‚úèÔ∏è</button>
                                    <button class="delete-btn" data-id="${escapeHtml(record.id)}" title="–£–¥.">üóëÔ∏è</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                        
                        const totalRow = document.createElement('tr');
                        totalRow.className = 'total-row';
                        totalRow.innerHTML = `
                            <td colspan="7" style="text-align: right; font-weight: 700;">–ò–¢–û–ì–û:</td>
                            <td class="payment-cell" style="font-weight: 700;">${formatPayment(totalSum)} ‚ÇΩ</td>
                            <td colspan="3"></td>
                        `;
                        tbody.appendChild(totalRow);
                    }
                    updateReport();
                }

                function clearForm() {
                    document.getElementById('clientId').value = generateNewId();
                    document.getElementById('userName').value = '';
                    document.getElementById('phone').value = '';
                    document.getElementById('carModel').value = '';
                    document.getElementById('visitDate').value = '';
                    document.getElementById('visitTime').value = '';
                    document.getElementById('oilChange').value = '–ù–µ—Ç';
                    document.getElementById('payment').value = '0';
                    document.getElementById('statusSelect').value = 'waiting';
                    document.getElementById('comment').value = '';
                    editingId = null;
                    document.getElementById('addBtn').style.display = 'inline-block';
                    document.getElementById('updateBtn').style.display = 'none';
                    document.getElementById('cancelEdit').style.display = 'none';
                }

                function fillFormForEdit(record) {
                    document.getElementById('clientId').value = record.id;
                    document.getElementById('userName').value = record.name || '';
                    document.getElementById('phone').value = record.phone || '';
                    document.getElementById('carModel').value = record.carModel || '';
                    document.getElementById('visitDate').value = record.visitDate || '';
                    document.getElementById('visitTime').value = record.visitTime || '';
                    document.getElementById('oilChange').value = record.oilChange || '–ù–µ—Ç';
                    document.getElementById('payment').value = record.payment || 0;
                    document.getElementById('statusSelect').value = record.status || 'waiting';
                    document.getElementById('comment').value = record.comment || '';
                    editingId = record.id;
                    document.getElementById('addBtn').style.display = 'none';
                    document.getElementById('updateBtn').style.display = 'inline-block';
                    document.getElementById('cancelEdit').style.display = 'inline-block';
                }

                function addRecord() {
                    const clientId = document.getElementById('clientId').value.trim();
                    const name = document.getElementById('userName').value.trim();
                    const phone = document.getElementById('phone').value.trim();
                    const carModel = document.getElementById('carModel').value.trim();
                    const visitDate = document.getElementById('visitDate').value;
                    const visitTime = document.getElementById('visitTime').value;
                    const oilChange = document.getElementById('oilChange').value;
                    const payment = document.getElementById('payment').value ? Number(document.getElementById('payment').value) : 0;
                    const status = document.getElementById('statusSelect').value;
                    const comment = document.getElementById('comment').value.trim();

                    if (!name || !phone) {
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω.');
                        return;
                    }

                    if (records.some(r => r.id === clientId)) {
                        alert('–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ID —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.');
                        clearForm();
                        return;
                    }

                    const newRecord = {
                        id: clientId,
                        name,
                        phone,
                        carModel,
                        visitDate,
                        visitTime,
                        oilChange,
                        payment,
                        status,
                        comment
                    };

                    records.push(newRecord);
                    saveToStorage();
                    updateYearFilter();
                    clearForm();
                    renderTable();
                }

                function updateRecord() {
                    const clientId = document.getElementById('clientId').value.trim();
                    const name = document.getElementById('userName').value.trim();
                    const phone = document.getElementById('phone').value.trim();
                    const carModel = document.getElementById('carModel').value.trim();
                    const visitDate = document.getElementById('visitDate').value;
                    const visitTime = document.getElementById('visitTime').value;
                    const oilChange = document.getElementById('oilChange').value;
                    const payment = document.getElementById('payment').value ? Number(document.getElementById('payment').value) : 0;
                    const status = document.getElementById('statusSelect').value;
                    const comment = document.getElementById('comment').value.trim();

                    if (!name || !phone) {
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω.');
                        return;
                    }

                    const index = records.findIndex(r => r.id === editingId);
                    if (index === -1) {
                        alert('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');
                        clearForm();
                        renderTable();
                        return;
                    }

                    if (editingId !== clientId && records.some(r => r.id === clientId)) {
                        alert('–ó–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º ID —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.');
                        return;
                    }

                    records[index] = {
                        id: clientId,
                        name,
                        phone,
                        carModel,
                        visitDate,
                        visitTime,
                        oilChange,
                        payment,
                        status,
                        comment
                    };

                    saveToStorage();
                    updateYearFilter();
                    clearForm();
                    renderTable();
                }

                function deleteRecord(id) {
                    if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
                        records = records.filter(r => r.id !== id);
                        saveToStorage();
                        updateYearFilter();
                        if (editingId === id) clearForm();
                        renderTable();
                    }
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                loadFromServer(); // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑–≤–Ω–µ
                window.appInstance = {
                    loadFromServer: loadFromServer
                };

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                document.getElementById('addBtn').addEventListener('click', addRecord);
                document.getElementById('updateBtn').addEventListener('click', updateRecord);
                document.getElementById('cancelEdit').addEventListener('click', clearForm);
                document.getElementById('syncNowBtn').addEventListener('click', loadFromServer);
                
                document.getElementById('searchInput').addEventListener('input', renderTable);
                
                document.querySelectorAll('.status-checkbox').forEach(cb => {
                    cb.addEventListener('change', renderTable);
                });

                document.getElementById('oilYes').addEventListener('change', renderTable);
                document.getElementById('oilNo').addEventListener('change', renderTable);
                document.getElementById('oilSoon').addEventListener('change', renderTable);
                
                document.getElementById('yearFilter').addEventListener('change', renderTable);
                document.getElementById('monthFilter').addEventListener('change', renderTable);

                document.getElementById('tableBody').addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const id = target.getAttribute('data-id');
                    if (target.classList.contains('delete-btn')) {
                        deleteRecord(id);
                    } else if (target.classList.contains('edit-btn')) {
                        const record = records.find(r => r.id === id);
                        if (record) fillFormForEdit(record);
                    }
                });

                // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                setInterval(() => {
                    if (document.getElementById('appScreen').style.display !== 'none') {
                        loadFromServer();
                    }
                }, 30000);
            }
        })();
    </script>
</body>
</html>
